{% extends 'base.html' %}

{% block head %}
    <title>{{ post.title }} - Jy's Blog</title>
{% endblock head %}

{% block title %}{{ post.title }}{% endblock title %}

{% block content %}
    <div class="post-box">
        <div class="post-content">{{ post.text|safe|linebreaksbr }}</div>
    </div>

    <div class="post-toolbox text-right">
        <button id="btn-modify" class="btn btn-primary">수정</button>
        <button id="btn-delete" class="btn btn-danger">삭제</button>
        <button id="btn-list" class="btn btn-secondary">목록</button>
    </div>

    <div class="separate-line">
        <hr/>
    </div>

    <div class="comment-area">
        <div class="comment-header">
            <h3>{{ post.comments.count }}개의 댓글</h3>
        </div>
        <div class="comment-input">
            <form method="post">
                {% csrf_token %}
                {{ form.author }}
                {{ form.text }}
                <button class="btn btn-sm btn-secondary" type="submit">작성하기</button>
            </form>
        </div>
        <div class="comment-body">
            {% for comment in post.comments.all %}
                <div class="comment row">
                    <div class="col-3 comment-author">{{ comment.author }}</div>
                    <div class="col-9 comment-text">{{ comment.text }}</div>
                    <div class="col-6">
                        <span class="comment-like" data-id="{{ comment.id }}">
                            <i class="fa fa-thumbs-up"></i>
                            <span class="like-count">{{ comment.like.count }}</span>
                        </span>
                    </div>
                    <div class="col-6 comment-date">{{ comment.created_date }}</div>
                </div>
            {% empty %}
                <div class="comment">
                    <h6>이 포스트에 아직 댓글이 존재하지 않습니다.</h6>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script type="text/javascript">
        $(document).ready(function () {
            $("#btn-list").click(function () {
                location.href = "{% url 'post_list' %}";
            });

            $("#btn-modify").click(function () {
                location.href = "{% url 'post_edit' pk=post.id %}";
            });

            $("#btn-delete").click(function () {
                if (confirm("정말로 게시글을 삭제하시겠습니까?"))
                    location.href = "{% url 'post_delete' pk=post.id %}";
            });

            $(".comment-like").click(function () {
                const countArea = $(this).children('.like-count');

                $.ajax({
                    type: 'POST',
                    url: '{% url 'comment_like' %}',
                    data: {'pk': $(this).data('id')},
                    dataType: 'json',

                    success: function(response) {
                        countArea.text(response.like_count);

                        if (response.success === 'authRequired')
                            alert('로그인 후 이용해주세요.');
                    }
                });
            });
        });
    </script>
{% endblock script %}