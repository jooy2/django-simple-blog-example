{% extends 'base.html' %}

{% block head %}
    <title>{{ post.title }} - Jy's Blog</title>
{% endblock head %}

{% block title %}{{ post.title }}{% endblock title %}

{% block content %}
    <div class="post-info row">
        <div class="col-6 font-weight-bold"><i class="fa fa-user mr-2"></i>{{ post.author }} 작성</div>
        <div class="col-6 text-right">{{ post.created_date }}<i class="fa fa-clock ml-2"></i></div>
    </div>

    <div class="post-box">
        <div class="post-content">{{ post.text|safe|linebreaksbr }}</div>
    </div>

    <div class="post-toolbox text-right">
        {% if request.user == post.author %}
            <button id="btn-modify" class="blog-button blog-button-round blog-button-sm color-notice">
                <i class="fa fa-pencil-alt mr-2"></i>수정
            </button>
            <button id="btn-delete" class="blog-button blog-button-round blog-button-sm color-danger">
                <i class="fa fa-trash mr-2"></i>삭제
            </button>
        {% endif %}
        <button id="btn-list" class="blog-button blog-button-round blog-button-sm">
            <i class="fa fa-list mr-2"></i>목록
        </button>
    </div>

    <div class="separate-line">
        <hr/>
    </div>

    <div class="comment-area">
        <div class="comment-header">
            <h3><i class="fa fa-comment mr-2"></i>{{ post.comments.count }}개의 댓글</h3>
        </div>
        <div class="comment-input">
            <form method="post">
                <div class="row no-gutters">
                    <div class="col-3 col-lg-2 pr-2">
                        {{ form.author }}
                    </div>
                    <div class="col-7 col-lg-9 pr-2">
                        {{ form.text }}
                    </div>
                    <div class="col-2 col-lg-1">
                        <button class="btn btn-sm btn-secondary w-100 h-100" type="submit">작성하기</button>
                    </div>
                    {% csrf_token %}
                </div>
            </form>
        </div>
        <div class="comment-body">
            {% for comment in post.comments.all %}
                <div class="comment row">
                    <div class="col-4 comment-author">{{ comment.author }}</div>
                    <div class="col-8 comment-text">{{ comment.text }}</div>
                    <div class="offset-4 col-4 comment-date">{{ comment.created_date }}</div>
                    <div class="col-4 text-right">
                        {% if request.user.username == comment.author %}
                            <span class="comment-delete mr-2" data-id="{{ comment.id }}">
                                <i class="fa fa-times-circle"></i>
                                <span class="">삭제</span>
                            </span>
                        {% endif %}
                        <span class="comment-like" data-id="{{ comment.id }}">
                            <i class="fa fa-thumbs-up"></i>
                            <span class="like-count">{{ comment.like.count }}</span>
                        </span>
                    </div>
                    {% for comm in comment.like.all %}
                    {% endfor %}
                </div>
            {% empty %}
                <div class="comment">
                    <h6>이 포스트에 아직 댓글이 존재하지 않습니다.</h6>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script type="text/javascript">
        $(document).ready(function () {
            const author = $("#id_author");

            if (author.val())
                author.attr('readonly', true);

            $("#btn-list").click(function () {
                location.href = "{% url 'post_list' %}";
            });

            $("#btn-modify").click(function () {
                location.href = "{% url 'post_edit' pk=post.id %}";
            });

            $("#btn-delete").click(function () {
                if (confirm("정말로 게시글을 삭제하시겠습니까?"))
                    location.href = "{% url 'post_delete' pk=post.id %}";
            });

            $(".comment-delete").click(function () {
                let commentArea = $(this).parents()[1];

                $.ajax({
                    type: 'POST',
                    url: '{% url 'comment_delete' %}',
                    data: {'pk': $(this).data('id')},
                    dataType: 'json',
                    success: function(response) {
                        response.success === 'removed' ?
                            commentArea.remove() : alert('잘못된 시도입니다.');
                    }
                });
            });

            $(".comment-like").click(function () {
                const countArea = $(this).children('.like-count');
                const likeButton = $(this);

                $.ajax({
                    type: 'POST',
                    url: '{% url 'comment_like' %}',
                    data: {'pk': $(this).data('id')},
                    dataType: 'json',
                    success: function(response) {
                        countArea.text(response.like_count);

                        switch (response.success) {
                            case 'authRequired':
                                alert('로그인 후 이용해주세요.');
                                break;
                            case 'added':
                                likeButton.addClass('active');
                                break;
                            case 'removed':
                                likeButton.removeClass('active');
                                break;
                            default:
                                break;
                        }
                    }
                });
            });
        });
    </script>
{% endblock script %}